---
tags: 
draft: true
lastmod: 2024-06-25T11:23:40+08:00
title: linux-0.11 _set_gate 宏解释
date: 2024-06-13
---

 `_set_gate`，用于设置中断门或陷阱门（gate）在全局描述符表（GDT）或中断描述符表（IDT）中的入口。这段代码利用内嵌汇编实现了对描述符表入口的初始化。

```c
#define _set_gate(gate_addr,type,dpl,addr) \
__asm__ ("movw %%dx,%%ax\n\t" \
    "movw %0,%%dx\n\t" \
    "movl %%eax,%1\n\t" \
    "movl %%edx,%2" \
    : \
    : "i" ((short) (0x8000+(dpl<<13)+(type<<8))), \
    "o" (*((char *) (gate_addr))), \
    "o" (*(4+(char *) (gate_addr))), \
    "d" ((char *) (addr)),"a" (0x00080000))
```

1. `#define _set_gate(gate_addr,type,dpl,addr)`: 定义一个宏 `_set_gate`，它接受四个参数：
    
    * `gate_addr`：门描述符的地址。
    * `type`：描述符类型。
    * `dpl`：描述符特权级（Descriptor Privilege Level）。
    * `addr`：门处理程序的地址。
2. `__asm__`：内嵌汇编开始。
    
3. `"movw %%dx,%%ax\n\t"`：将寄存器 `dx` 的低16位复制到寄存器 `ax`。
    
4. `"movw %0,%%dx\n\t"`：将第一个输入操作数 `%0` 的值复制到寄存器 `dx`。
    
5. `"movl %%eax,%1\n\t"`：将寄存器 `eax` 的值复制到第二个输入操作数 `%1` 指向的内存位置。
    
6. `"movl %%edx,%2"`：将寄存器 `edx` 的值复制到第三个输入操作数 `%2` 指向的内存位置。
    
7. `:`：汇编指令部分结束。
    
8. `:`：输入操作数部分开始。
    
9. `"i" ((short) (0x8000+(dpl<<13)+(type<<8)))`：这是第一个输入操作数，它是一个立即数，表示门描述符的高16位，其中包含了描述符的类型和特权级。`0x8000`设置了存在位，`dpl<<13`将特权级左移13位，`type<<8`将类型左移8位。
    
10. `"o" (*((char *) (gate_addr)))`：这是第二个输入操作数，表示门描述符的低32位的内存地址。
    
11. `"o" (*(4+(char *) (gate_addr)))`：这是第三个输入操作数，表示门描述符的高32位的内存地址。`(4+(char *) (gate_addr))`指向门描述符后4个字节的地址。
    
12. `"d" ((char *) (addr))`：这是第四个输入操作数，将处理程序地址传递给 `dx` 寄存器。
    
13. `"a" (0x00080000)`：这是第五个输入操作数，将选择子（segment selector）传递给 `ax` 寄存器，选择子值为 `0x0008`，表示代码段选择子。
    

综上所述，这段代码通过内嵌汇编指令将门描述符的各个部分（选择子、特权级、类型和处理程序地址）写入指定的内存位置，完成对中断门或陷阱门描述符的初始化。